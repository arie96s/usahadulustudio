<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USAHADULU | Clients</title>
    <meta name="description" content="Testimoni klien USAHADULU. Review jujur dari pelanggan kami.">
    <link rel="icon" type="image/png" href="img/logo_ambigram.png">
    
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
</head>
<body>
    <div id="preloader"><img src="img/logo_ambigram.png" class="loader-logo"></div>
    <div id="cursor"></div>
    
    <header id="mainHeader">
        <div class="header-left">
            <div class="brand-logo hover-target"><a href="index.html"><img id="headerLogoImg" src="img/logo_ambigram.png" alt="HOME"></a></div>
        </div>
        <div style="display:flex; align-items:center;">
             <div class="menu-btn hover-target" id="menuBtn"><span></span><span></span><span></span></div>
        </div>
    </header>

   <div class="nav-overlay" id="navOverlay">
        <ul class="menu-list">
            <li class="menu-item"><a href="services.html" class="menu-title hover-target">SERVICES</a></li>
            <li class="menu-item"><a href="portfolio.html" class="menu-title hover-target">PORTFOLIO</a></li>
            <li class="menu-item"><a href="testimonial.html" class="menu-title hover-target">CLIENTS & REVIEWS</a></li>
            <li class="menu-item"><a href="about.html" class="menu-title hover-target">ABOUT US</a></li>
        </ul>
    </div>

    <div class="page-content">
        <h1 class="page-title">CLIENTS & REVIEWS</h1>
        
        <div id="adminBadge" style="display:none; text-align:center; margin-bottom:20px;">
            <span style="background:red; color:white; padding:5px 10px; font-size:10px; font-weight:bold; border-radius:4px;">
                GOD MODE ACTIVE
            </span>
        </div>

        <div class="review-input-section" id="secretReviewForm" style="display: none;">
            <h3 style="margin-bottom:10px; font-size:14px; color:#fff;">TULIS PENGALAMAN ANDA</h3>
            <div class="star-rating-container">
                <span class="star-icon hover-target" data-val="1">★</span>
                <span class="star-icon hover-target" data-val="2">★</span>
                <span class="star-icon hover-target" data-val="3">★</span>
                <span class="star-icon hover-target" data-val="4">★</span>
                <span class="star-icon hover-target" data-val="5">★</span>
            </div>
            
            <div class="review-form-container" id="reviewFormContainer" style="display:block;">
                <input type="text" id="reviewName" class="review-input" placeholder="Nama Anda / Brand">
                <input type="text" id="reviewProject" class="review-input" placeholder="Project (Misal: Logo Design)">
                <textarea id="reviewComment" class="review-input" rows="3" placeholder="Ceritakan pengalaman Anda..."></textarea>
                <button class="submit-review-btn hover-target" id="btnSubmitReview">KIRIM ULASAN</button>
            </div>
        </div>

        <div class="testimonial-grid" id="testimonialGrid">
            <p style="text-align:center; width:100%; color:#666;">Memuat data...</p>
        </div>
    </div>

    <script src="js/data.js"></script>
    <script src="js/main.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp, doc, deleteDoc } 
        from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        // Konfigurasi Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBW0DwqgnbXlDW7hR_Trlpge5LKm2dwXjk",
            authDomain: "usahadulu-studio.firebaseapp.com",
            projectId: "usahadulu-studio",
            storageBucket: "usahadulu-studio.firebasestorage.app",
            messagingSenderId: "196725488044",
            appId: "1:196725488044:web:0d2486d434cd4dd8662209"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- 1. LOGIKA MODE (WRITE vs GOD) ---
        const urlParams = new URLSearchParams(window.location.search);
        const isClientMode = urlParams.get('write') === 'mode'; // Untuk Klien
        const isGodMode = urlParams.get('god') === 'mode';       // Untuk Owner (Fajri)
        const newReviewId = urlParams.get('new_id');

        // Jika mode Client, tampilkan Form
        if(isClientMode) {
            document.getElementById('secretReviewForm').style.display = 'block';
        }

        // Jika mode God, tampilkan Badge Admin
        if(isGodMode) {
            document.getElementById('adminBadge').style.display = 'block';
        }

        // Setup Bintang Rating
        let selectedRating = 5;
        const stars = document.querySelectorAll('.star-icon');
        stars.forEach(star => {
            star.classList.add('active'); 
            star.addEventListener('click', function() {
                selectedRating = parseInt(this.getAttribute('data-val'));
                stars.forEach(s => {
                    const sVal = parseInt(s.getAttribute('data-val'));
                    if (sVal <= selectedRating) s.classList.add('active');
                    else s.classList.remove('active');
                });
            });
        });

        // --- 2. LOAD DATA ---
        async function loadTestimonials() {
            const grid = document.getElementById('testimonialGrid');
            grid.innerHTML = ''; 

            try {
                const q = query(collection(db, "testimonials"), orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    grid.innerHTML = '<p style="text-align:center;">Belum ada ulasan.</p>';
                    return;
                }

                querySnapshot.forEach((documentSnapshot) => { 
                    const data = documentSnapshot.data();
                    const docId = documentSnapshot.id;
                    const isNew = docId === newReviewId;
                    
                    const card = document.createElement('div');
                    card.className = `testi-card ${isNew ? 'new-entry' : ''}`;
                    
                    let starHtml = '';
                    for(let i=0; i<data.rating; i++) starHtml += '★';

                    // --- LOGIKA TOMBOL HAPUS ---
                    // Tombol Hapus HANYA muncul jika GOD MODE aktif
                    const deleteBtnHtml = isGodMode ? 
                        `<button class="delete-btn" onclick="window.hapusReview('${docId}')">HAPUS PERMANEN</button>` : '';

                    card.innerHTML = `
                        <div class="testi-quote">${data.comment}</div>
                        <div style="color:#ffd700; font-size:12px; margin: 10px 0 5px;">${starHtml}</div>
                        <span class="testi-author">${data.name}</span>
                        <span class="testi-brand">${data.project}</span>
                        <div style="text-align:right;">${deleteBtnHtml}</div>
                    `;
                    grid.appendChild(card);
                });

                if(newReviewId) {
                    setTimeout(() => {
                        const newElement = document.querySelector('.new-entry');
                        if(newElement) newElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 500);
                }

            } catch (error) {
                console.error("Error loading reviews:", error);
                grid.innerHTML = '<p style="text-align:center; color:red;">Gagal memuat data.</p>';
            }
        }

        // --- 3. SUBMIT REVIEW (Hanya bisa diakses di Client Mode) ---
        document.getElementById('btnSubmitReview').addEventListener('click', async () => {
            const name = document.getElementById('reviewName').value;
            const project = document.getElementById('reviewProject').value;
            const comment = document.getElementById('reviewComment').value;
            const btn = document.getElementById('btnSubmitReview');

            if(!name || !comment) { alert("Mohon isi Nama dan Pengalaman Anda."); return; }

            btn.innerText = "Mengirim...";
            btn.disabled = true;

            try {
                const docRef = await addDoc(collection(db, "testimonials"), {
                    name: name,
                    project: project || "Client",
                    comment: comment,
                    rating: selectedRating,
                    timestamp: serverTimestamp()
                });
                // Redirect agar form bersih kembali
                window.location.href = `testimonial.html?new_id=${docRef.id}`;
            } catch (error) {
                console.error("Error:", error);
                alert("Gagal mengirim: " + error.message);
                btn.innerText = "KIRIM ULASAN";
                btn.disabled = false;
            }
        });

        // --- 4. FUNGSI HAPUS (Hanya jalan di God Mode) ---
        window.hapusReview = async function(id) {
            // Validasi ganda: Pastikan benar-benar God Mode
            if(!isGodMode) return; 

            if(confirm("⚠ PERINGATAN: Testimoni ini akan dihapus permanen dari database. Lanjut?")) {
                try {
                    await deleteDoc(doc(db, "testimonials", id));
                    alert("Data berhasil dimusnahkan.");
                    loadTestimonials(); // Refresh tanpa reload
                } catch (error) {
                    alert("Gagal hapus: " + error.message);
                }
            }
        }

        loadTestimonials();
    </script>
</body>
</html>
