<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USAHADULU | Clients</title>
    <meta name="description" content="Testimoni klien USAHADULU. Review jujur dari pelanggan kami.">
    <meta property="og:image" content="img/logo_ambigram.png">
    <link rel="icon" type="image/png" href="img/logo_ambigram.png">
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
</head>
<body>
    <div id="preloader"><img src="img/logo_ambigram.png" class="loader-logo"></div>
    <div id="cursor"></div>
    <a href="#" id="waFloatBtn" target="_blank" class="float-wa hover-target">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M380.9 97.1C339 55.1 283.2 32 223.9 32c-122.4 0-222 99.6-222 222 0 39.1 10.2 77.3 29.6 111L0 480l117.7-30.9c32.4 17.7 68.9 27 106.1 27h.1c122.3 0 224.1-99.6 224.1-222 0-59.3-25.2-115-67.1-157zm-157 341.6c-33.2 0-65.7-8.9-94-25.7l-6.7-4-69.8 18.3L72 359.2l-4.4-7c-18.5-29.4-28.2-63.3-28.2-98.2 0-101.7 82.8-184.5 184.6-184.5 49.3 0 95.6 19.2 130.4 54.1 34.8 34.9 56.2 81.2 56.1 130.5 0 101.8-84.9 184.6-186.6 184.6zm101.2-138.2c-5.5-2.8-32.8-16.2-37.9-18-5.1-1.9-8.8-2.8-12.5 2.8-3.7 5.6-14.3 18-17.6 21.8-3.2 3.7-6.5 4.2-12 1.4-32.6-16.3-54-29.1-75.5-66-5.7-9.8 5.7-9.1 16.3-30.3 1.8-3.7 .9-6.9-.5-9.7-1.4-2.8-12.5-30.1-17.1-41.2-4.5-10.8-9.1-9.3-12.5-9.5-3.2-.2-6.9-.2-10.6-.2-3.7 0-9.7 1.4-14.8 6.9-5.1 5.6-19.4 19-19.4 46.3 0 27.3 19.9 53.7 22.6 57.4 2.8 3.7 39.1 59.7 94.8 83.8 35.2 15.2 49 16.5 66.6 13.9 10.7-1.6 32.8-13.4 37.4-26.4 4.6-13 4.6-24.1 3.2-26.4-1.3-2.5-5-3.9-10.5-6.6z"/></svg>
    </a>

    <header id="mainHeader">
        <div class="header-left">
            <div class="brand-logo hover-target"><a href="index.html"><img id="headerLogoImg" src="img/logo_ambigram.png" alt="HOME"></a></div>
        </div>
        <div style="display:flex; align-items:center;">
            <div class="lang-switch hover-target" id="langToggle" data-lang="id" onclick="toggleLanguage()"><div class="lang-circle"></div></div>
            <div class="menu-btn hover-target" id="menuBtn"><span></span><span></span><span></span></div>
        </div>
    </header>

   <div class="nav-overlay" id="navOverlay">
        <ul class="menu-list">
            <li class="menu-item"><a href="services.html" class="menu-title hover-target" data-i18n="nav_services">SERVICES</a></li>
            <li class="menu-item"><a href="portfolio.html" class="menu-title hover-target" data-i18n="nav_portfolio">PORTFOLIO</a></li>
            <li class="menu-item"><a href="testimonial.html" class="menu-title hover-target" data-i18n="nav_testimonials">CLIENTS & REVIEWS</a></li>
            <li class="menu-item"><a href="https://arie96s.github.io/magosstreetwear" class="menu-title hover-target" data-i18n="nav_collection">OUR COLLECTION</a></li>
            <li class="menu-item">
    <li class="menu-item">
    <a href="shop.html" class="menu-title hover-target" style="color: #ccc; font-size: 20px;">
        <span data-i18n="nav_shop">ASSET STORE</span> 
        
        <span style="font-size: 10px; border: 1px solid #fff; padding: 2px 6px; vertical-align: middle; border-radius: 50px;">NEW</span> 
    </a>
</li>
            <li class="menu-item"><a href="about.html" class="menu-title hover-target" data-i18n="nav_about">ABOUT US</a></li>
        </ul>
    </div>

    <div class="page-content">
        <h1 class="page-title" data-i18n="nav_testimonials">CLIENTS & REVIEWS</h1>
        
        <div class="review-input-section" id="secretReviewForm">
            <h3 style="margin-bottom:10px; font-size:14px; color:#fff;">TULIS ULASAN ANDA</h3>
            <div class="star-rating-container">
                <span class="star-icon hover-target" data-val="1">★</span>
                <span class="star-icon hover-target" data-val="2">★</span>
                <span class="star-icon hover-target" data-val="3">★</span>
                <span class="star-icon hover-target" data-val="4">★</span>
                <span class="star-icon hover-target" data-val="5">★</span>
            </div>
            
            <div class="review-form-container" id="reviewFormContainer" style="display:block;">
                <input type="text" id="reviewName" class="review-input" placeholder="Nama Anda / Brand">
                <input type="text" id="reviewProject" class="review-input" placeholder="Project (Misal: Logo Design)">
                <textarea id="reviewComment" class="review-input" rows="3" placeholder="Bagaimana pengalaman Anda?"></textarea>
                <button class="submit-review-btn hover-target" id="btnSubmitReview">KIRIM ULASAN</button>
            </div>
        </div>

        <div class="testimonial-grid" id="testimonialGrid">
            <p style="text-align:center; width:100%; color:#666;">Memuat ulasan terkini...</p>
        </div>
    </div>

<script src="js/data.js"></script>
    <script src="js/main.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp } 
        from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        // 1. Config Firebase (Sama seperti di index.html)
        const firebaseConfig = {
            apiKey: "AIzaSyBW0DwqgnbXlDW7hR_Trlpge5LKm2dwXjk",
            authDomain: "usahadulu-studio.firebaseapp.com",
            projectId: "usahadulu-studio",
            storageBucket: "usahadulu-studio.firebasestorage.app",
            messagingSenderId: "196725488044",
            appId: "1:196725488044:web:0d2486d434cd4dd8662209"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // 2. Cek URL Parameter (?mode=write)
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode');
        const newReviewId = urlParams.get('new_id'); // ID review baru untuk efek glow

        // Jika mode=write, tampilkan form
        if(mode === 'write') {
            document.getElementById('secretReviewForm').style.display = 'block';
        }

        // 3. Setup Bintang Rating
        let selectedRating = 5;
        const stars = document.querySelectorAll('.star-icon');
        stars.forEach(star => {
            star.classList.add('active'); // Default bintang 5 nyala
            star.addEventListener('click', function() {
                selectedRating = parseInt(this.getAttribute('data-val'));
                stars.forEach(s => {
                    const sVal = parseInt(s.getAttribute('data-val'));
                    if (sVal <= selectedRating) s.classList.add('active');
                    else s.classList.remove('active');
                });
            });
        });

        // 4. Load Data dari Firebase (READ)
        async function loadTestimonials() {
            const grid = document.getElementById('testimonialGrid');
            grid.innerHTML = ''; // Bersihkan loading text

            try {
                // Ambil data urut dari terbaru
                const q = query(collection(db, "testimonials"), orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    grid.innerHTML = '<p style="text-align:center;">Belum ada ulasan.</p>';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const isNew = doc.id === newReviewId; // Cek apakah ini review yg baru disubmit
                    
                    // Render HTML Card
                    const card = document.createElement('div');
                    card.className = `testi-card ${isNew ? 'new-entry' : ''}`;
                    
                    // Generate Bintang (Visual Only)
                    let starHtml = '';
                    for(let i=0; i<data.rating; i++) starHtml += '★';

                    card.innerHTML = `
                        <div class="testi-quote">${data.comment}</div>
                        <div style="color:#ffd700; font-size:12px; margin-bottom:5px;">${starHtml}</div>
                        <span class="testi-author">${data.name}</span>
                        <span class="testi-brand">${data.project}</span>
                    `;
                    grid.appendChild(card);
                });

                // Scroll ke review baru jika ada
                if(newReviewId) {
                    setTimeout(() => {
                        const newElement = document.querySelector('.new-entry');
                        if(newElement) {
                            newElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            // Hilangkan glow setelah 5 detik
                            setTimeout(() => newElement.classList.remove('new-entry'), 5000);
                        }
                    }, 500);
                }

            } catch (error) {
                console.error("Error loading reviews:", error);
                // Fallback ke data.js statis jika error / offline
                if(typeof renderTestimonials === 'function') renderTestimonials(); 
            }
        }

        // 5. Submit Data ke Firebase (CREATE)
        document.getElementById('btnSubmitReview').addEventListener('click', async () => {
            const name = document.getElementById('reviewName').value;
            const project = document.getElementById('reviewProject').value;
            const comment = document.getElementById('reviewComment').value;
            const btn = document.getElementById('btnSubmitReview');

            if(!name || !comment) { alert("Mohon isi Nama dan Komentar."); return; }

            btn.innerText = "Mengirim...";
            btn.disabled = true;

            try {
                const docRef = await addDoc(collection(db, "testimonials"), {
                    name: name,
                    project: project || "Client",
                    comment: comment,
                    rating: selectedRating,
                    timestamp: serverTimestamp() // Waktu server
                });

                // Redirect untuk refresh page dan hilangkan mode form + tambah efek glow
                window.location.href = `testimonial.html?new_id=${docRef.id}`;

            } catch (error) {
                console.error("Error adding document: ", error);
                alert("Gagal mengirim ulasan. Cek koneksi internet.");
                btn.innerText = "KIRIM ULASAN";
                btn.disabled = false;
            }
        });

        // Jalankan Load Data
        loadTestimonials();
    </script>
</body>
</html>