<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAGOS | CONTROL TERMINAL</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --m-green: #25D366; --m-border: #222; }
        body { background: #000; color: #fff; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        .terminal-wrapper { max-width: 1000px; margin: 40px auto; padding: 20px; }
        
        .terminal-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; }
        .panel { background: #080808; border: 1px dashed var(--m-border); padding: 25px; border-radius: 20px; }
        
        h1 { font-size: 18px; letter-spacing: 3px; font-weight: 900; margin-bottom: 30px; border-left: 4px solid #fff; padding-left: 15px; }
        label { font-size: 9px; color: #555; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; display: block; margin-bottom: 8px; }
        
        input, select, textarea { 
            width: 100%; background: #000; border: 1px solid #1a1a1a; padding: 14px; 
            color: #fff; border-radius: 8px; font-family: monospace; font-size: 13px; margin-bottom: 15px; box-sizing: border-box;
        }

        .btn-group { display: flex; flex-direction: column; gap: 12px; }
        .btn-main { 
            padding: 20px; border-radius: 12px; font-weight: 900; font-size: 11px; 
            text-transform: uppercase; cursor: pointer; border: none; transition: 0.3s;
        }
        .btn-invoice { background: #fff; color: #000; }
        .btn-label { background: transparent; color: #fff; border: 1px solid #333; }
        .btn-sync { background: var(--m-green); color: #000; margin-bottom: 20px; width: 100%; }
        .btn-danger { background: #cc0000; color: #fff; margin-top: 10px; }

        @media (max-width: 768px) {
            .terminal-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="terminal-wrapper">
    <h1>MAGOS CONTROL CENTER</h1>
    
    <button class="btn-main btn-sync" onclick="fetchLatestOrder()">FETCH LATEST ORDER DATA</button>

    <div class="terminal-grid">
        <div class="panel">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <label>ORDER ID</label>
                    <input type="text" id="orderID" placeholder="#MG-XXXX">
                </div>
                <div>
                    <label>DATE</label>
                    <input type="text" id="orderDate" readonly>
                </div>
            </div>
            
            <label>CUSTOMER NAME</label>
            <input type="text" id="custName" placeholder="NAMA PENERIMA">
            
            <label>PHONE SIGNAL (WHATSAPP)</label>
            <input type="text" id="custPhone" placeholder="628XXXXXXXX">
            
            <label>ADDRESS COORDINATES</label>
            <textarea id="custAddr" rows="3" placeholder="ALAMAT LENGKAP..."></textarea>
            
            <label>COURIER SERVICE</label>
            <select id="orderCourier">
                <option value="JNE REG">JNE REG</option>
                <option value="J&T EXPRESS">J&T EXPRESS</option>
                <option value="DHL INT">DHL INT</option>
            </select>
        </div>

        <div class="panel">
            <label>ACTIVE PRODUCT DETECTED</label>
            <select id="orderProduct" onchange="updateValuation()">
                <option value="" disabled selected>PILIH PRODUK</option>
            </select>
            
            <label>SIZE</label>
            <select id="orderSize">
                <option value="S">S</option><option value="M">M</option>
                <option value="L">L</option><option value="XL">XL</option>
                <option value="XXL">XXL</option><option value="ALL SIZE">ALL SIZE</option>
            </select>
            
            <div style="padding: 20px; background: #000; border: 1px solid #111; margin-bottom: 20px; border-radius: 12px;">
                <label>TRANSACTION VALUATION</label>
                <div id="liveTotal" style="font-size: 24px; font-weight: 900; color: var(--m-green);">Rp 0</div>
            </div>

            <div class="btn-group">
                <button class="btn-main btn-invoice" onclick="generateInvoicePDF()">GENERATE INVOICE</button>
                <button class="btn-main btn-label" onclick="printShippingLabel()">GENERATE SHIPPING LABEL</button>
                <button class="btn-main btn-danger" onclick="clearQueue()">ARCHIVE & CLEAR QUEUE</button>
                <button class="btn-main" style="background:transparent; color:#444;" onclick="location.reload()">RESET TERMINAL</button>
            </div>
        </div>
    </div>
</div>

<script>
    window.onload = () => {
        document.getElementById('orderDate').value = new Date().toLocaleDateString('id-ID');
        loadDatabase();
        setTimeout(fetchLatestOrder, 500); // Delay sedikit agar database terisi
    };

    function loadDatabase() {
        const data = JSON.parse(localStorage.getItem('magos_products_data') || "[]");
        const select = document.getElementById('orderProduct');
        select.innerHTML = '<option value="" disabled selected>PILIH PRODUK</option>';
        data.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.dataset.price = p.price;
            opt.text = `${p.id} | ${p.name}`;
            select.appendChild(opt);
        });
    }

    // FUNGSI SINKRONISASI OTOMATIS
    function fetchLatestOrder() {
        const pendingData = JSON.parse(localStorage.getItem('magos_pending_checkout') || "{}");

        if (pendingData.orderID) {
            // Mapping Identitas
            document.getElementById('orderID').value = pendingData.orderID;
            document.getElementById('custName').value = (pendingData.name || "").toUpperCase();
            document.getElementById('custPhone').value = pendingData.phone || "";
            document.getElementById('custAddr').value = `${pendingData.addr || ""}, ${pendingData.city || ""}, ${pendingData.prov || ""}`.toUpperCase();
            
            // Mapping Kurir Otomatis
            const courierSelect = document.getElementById('orderCourier');
            const courierVal = pendingData.courier || "";
            if (courierVal.includes("JNE")) courierSelect.value = "JNE REG";
            else if (courierVal.includes("J&T")) courierSelect.value = "J&T EXPRESS";
            else if (courierVal.includes("DHL")) courierSelect.value = "DHL INT";

            // Mapping Produk Pertama (Otomatisasi)
            if (pendingData.items && pendingData.items.length > 0) {
                const firstItem = pendingData.items[0];
                const productSelect = document.getElementById('orderProduct');
                
                for (let i = 0; i < productSelect.options.length; i++) {
                    if (productSelect.options[i].value === firstItem.id) {
                        productSelect.selectedIndex = i;
                        break;
                    }
                }
                document.getElementById('orderSize').value = firstItem.size || "ALL SIZE";
                updateValuation();
            }
            console.log("Terminal: Data Synced Successfully.");
        } else {
            console.log("Terminal: No pending order found.");
        }
    }

    function updateValuation() {
        const select = document.getElementById('orderProduct');
        const price = parseInt(select.options[select.selectedIndex]?.dataset.price || 0);
        document.getElementById('liveTotal').innerText = "Rp " + price.toLocaleString('id-ID');
    }

    function clearQueue() {
        if(confirm("Arsip pesanan ini dan bersihkan antrian?")) {
            localStorage.removeItem('magos_pending_checkout');
            location.reload();
        }
    }

    function generateInvoicePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const select = document.getElementById('orderProduct');
        if (select.selectedIndex <= 0) return alert("Pilih produk terlebih dahulu!");
        
        const price = parseInt(select.options[select.selectedIndex].dataset.price || 0);
        const name = document.getElementById('custName').value;
        const orderID = document.getElementById('orderID').value;

        // Header
        doc.setFillColor(0, 0, 0);
        doc.rect(0, 0, 210, 40, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(22);
        doc.text("MAGOS ARCHIVE", 15, 25);
        
        doc.setFontSize(8);
        doc.text("ORDER ID: " + orderID, 150, 20);
        doc.text("DATE: " + document.getElementById('orderDate').value, 150, 25);

        // Body
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(10);
        doc.text("BILL TO: " + name.toUpperCase(), 15, 60);
        doc.text("PHONE: " + document.getElementById('custPhone').value, 15, 65);

        doc.autoTable({
            startY: 80,
            head: [['ITEM DESCRIPTION', 'SIZE', 'UNIT PRICE', 'QTY', 'TOTAL']],
            body: [[select.options[select.selectedIndex].text.split('|')[1], document.getElementById('orderSize').value, "Rp " + price.toLocaleString('id-ID'), "1", "Rp " + price.toLocaleString('id-ID')]],
            theme: 'grid',
            headStyles: { fillColor: [0, 0, 0] }
        });

        doc.save(`INVOICE_${orderID}_${name.replace(/\s+/g, '_')}.pdf`);
    }

    function printShippingLabel() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: [105, 148] });
        const name = document.getElementById('custName').value.toUpperCase();
        const addr = document.getElementById('custAddr').value;
        const orderID = document.getElementById('orderID').value;
        const courier = document.getElementById('orderCourier').value;

        // Branding Label
        doc.setFillColor(0, 0, 0);
        doc.rect(0, 0, 105, 25, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(16);
        doc.text("MAGOS LOGISTICS", 8, 15);
        doc.setFontSize(20);
        doc.text("DUM", 80, 17); 

        doc.setTextColor(0, 0, 0);
        doc.setFontSize(8);
        doc.text("COURIER: " + courier, 8, 32);
        doc.setFontSize(7);
        doc.text("SHIP TO:", 8, 40);
        doc.setFontSize(12);
        doc.text(name, 8, 48);
        doc.setFontSize(9);
        doc.text(addr, 8, 55, { maxWidth: 90 });

        // Barcode Simulation
        doc.setFillColor(0, 0, 0);
        let startX = 15;
        for(let i=0; i<25; i++) {
            let w = Math.random() * 2 + 0.5;
            doc.rect(startX, 110, w, 15, 'F');
            startX += w + 0.8;
        }
        doc.setFontSize(10);
        doc.text(orderID, 52.5, 132, { align: 'center' });

        doc.save(`LABEL_${orderID}_${name.replace(/\s+/g, '_')}.pdf`);
    }
</script>
</body>
</html>