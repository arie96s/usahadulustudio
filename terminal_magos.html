<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAGOS | CONTROL TERMINAL</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --m-green: #25D366; --m-border: #222; }
        body { background: #000; color: #fff; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        .terminal-wrapper { max-width: 1000px; margin: 40px auto; padding: 20px; }
        
        /* Layout Grid */
        .terminal-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; }
        .panel { background: #080808; border: 1px dashed var(--m-border); padding: 25px; border-radius: 20px; }
        
        h1 { font-size: 18px; letter-spacing: 3px; font-weight: 900; margin-bottom: 30px; border-left: 4px solid #fff; padding-left: 15px; }
        label { font-size: 9px; color: #555; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; display: block; margin-bottom: 8px; }
        
        input, select, textarea { 
            width: 100%; background: #000; border: 1px solid #1a1a1a; padding: 14px; 
            color: #fff; border-radius: 8px; font-family: monospace; font-size: 14px; margin-bottom: 15px; box-sizing: border-box;
        }

        .btn-group { display: flex; flex-direction: column; gap: 12px; }
        .btn-main { 
            padding: 20px; border-radius: 12px; font-weight: 900; font-size: 11px; 
            text-transform: uppercase; cursor: pointer; border: none; transition: 0.3s;
        }
        .btn-invoice { background: #fff; color: #000; }
        .btn-label { background: transparent; color: #fff; border: 1px solid #333; }
        .btn-sync { background: var(--m-green); color: #000; margin-bottom: 20px; }

        /* Mobile Optimization */
        @media (max-width: 768px) {
            .terminal-grid { grid-template-columns: 1fr; }
            #liveTotal { font-size: 20px !important; text-align: center; }
        }
    </style>
</head>
<body>

<div class="terminal-wrapper">
    <h1>CONTROL_CENTER</h1>
    
    <button class="btn-main btn-sync" onclick="fetchLatestOrder()">FETCH LATEST ORDER DATA</button>

    <div class="terminal-grid">
        <div class="panel">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <label>ORDER ID</label>
                    <input type="text" id="orderID" value="#MG-">
                </div>
                <div>
                    <label>DATE</label>
                    <input type="text" id="orderDate" readonly>
                </div>
            </div>
            <label>CUSTOMER NAME</label>
            <input type="text" id="custName" placeholder="NAMA PENERIMA">
            <label>PHONE SIGNAL</label>
            <input type="text" id="custPhone" placeholder="628XXXXXXXX">
            <label>ADDRESS COORDINATES</label>
            <textarea id="custAddr" rows="3" placeholder="ALAMAT LENGKAP..."></textarea>
            <label>COURIER_SERVICE</label>
            <select id="orderCourier">
                <option value="JNE REG">JNE REG</option>
                <option value="J&T EXPRESS">J&T EXPRESS</option>
                <option value="DHL INT">DHL INT</option>
            </select>
        </div>

        <div class="panel">
            <label>SELECT PRODUCT</label>
            <select id="orderProduct" onchange="updateValuation()">
                <option value="" disabled selected>PILIH PRODUK</option>
            </select>
            <label>SIZE</label>
            <select id="orderSize">
                <option value="S">S</option><option value="M">M</option>
                <option value="L">L</option><option value="XL">XL</option>
                <option value="XXL">XXL</option><option value="ALL SIZE">ALL SIZE</option>
            </select>
            <div style="padding: 20px; background: #000; border: 1px solid #111; margin-bottom: 20px; border-radius: 12px;">
                <label>VALUATION</label>
                <div id="liveTotal" style="font-size: 24px; font-weight: 900; color: var(--m-green);">Rp 0</div>
            </div>
            <div class="btn-group">
                <button class="btn-main btn-invoice" onclick="generateInvoicePDF()">GENERATE INVOICE</button>
                <button class="btn-main btn-label" onclick="printShippingLabel()">DHL STYLE LABEL</button>
                <button class="btn-main" style="background:transparent; color:#444;" onclick="location.reload()">RESET TERMINAL</button>
            </div>
        </div>
    </div>
</div>

<script>
    window.onload = () => {
        document.getElementById('orderDate').value = new Date().toLocaleDateString('id-ID');
        loadDatabase();
        fetchLatestOrder(); // Otomatis cek data saat dibuka
    };

    // Sinkronisasi data dari checkout.html
    function fetchLatestOrder() {
        const logs = JSON.parse(localStorage.getItem('magos_warehouse_logs') || "[]");
        const pendingData = JSON.parse(localStorage.getItem('magos_pending_checkout') || "{}");

        if (pendingData.name) {
            document.getElementById('custName').value = pendingData.name.toUpperCase();
            document.getElementById('custPhone').value = pendingData.phone || "";
            document.getElementById('custAddr').value = `${pendingData.addr || ""}, ${pendingData.city || ""}, ${pendingData.prov || ""}`.toUpperCase();
            
            if (logs.length > 0) {
                const matchID = logs[0].msg.match(/#MG-[A-Z0-9]+/);
                if (matchID) document.getElementById('orderID').value = matchID[0];
            }
        }
    }

    function loadDatabase() {
        const data = JSON.parse(localStorage.getItem('magos_products_data') || "[]");
        const select = document.getElementById('orderProduct');
        data.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.dataset.price = p.price;
            opt.text = `${p.id} | ${p.name}`;
            select.appendChild(opt);
        });
    }

    function updateValuation() {
        const select = document.getElementById('orderProduct');
        const price = parseInt(select.options[select.selectedIndex]?.dataset.price || 0);
        document.getElementById('liveTotal').innerText = "Rp " + price.toLocaleString('id-ID');
    }

    function generateInvoicePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const select = document.getElementById('orderProduct');
        const price = parseInt(select.options[select.selectedIndex]?.dataset.price || 0);
        const name = document.getElementById('custName').value;

        if(!name) return alert("ERR: IDENTITY REQUIRED");

        doc.setFillColor(5, 5, 5);
        doc.rect(0, 0, 210, 40, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(22);
        doc.text("MAGOS ARCHIVE", 15, 25);
        
        doc.setFontSize(8);
        doc.text("ORDER ID: " + document.getElementById('orderID').value, 150, 20);
        doc.text("DATE: " + document.getElementById('orderDate').value, 150, 25);

        doc.setTextColor(0, 0, 0);
        doc.autoTable({
            startY: 90,
            head: [['ITEM', 'SIZE', 'PRICE', 'QTY', 'TOTAL']],
            body: [[select.options[select.selectedIndex].text.split('|')[1], document.getElementById('orderSize').value, "Rp " + price.toLocaleString('id-ID'), "1", "Rp " + price.toLocaleString('id-ID')]],
            theme: 'grid',
            headStyles: { fillColor: [0, 0, 0] }
        });

        doc.save(`INVOICE_MAGOS_${name.replace(/\s+/g, '_')}.pdf`);
    }

    function printShippingLabel() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: [105, 148] });
        const name = document.getElementById('custName').value.toUpperCase();
        const addr = document.getElementById('custAddr').value;
        const orderID = document.getElementById('orderID').value;

        // DHL Style Branding
        doc.setFillColor(0, 0, 0);
        doc.rect(0, 0, 105, 25, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(18);
        doc.text("MAGOS LOGISTICS", 8, 15);
        doc.setFontSize(24);
        doc.text("DUM", 80, 17); // Area Code Simulation

        doc.setTextColor(0, 0, 0);
        doc.setFontSize(8);
        doc.text("SHIP TO:", 8, 35);
        doc.setFontSize(14);
        doc.text(name, 8, 45);
        doc.setFontSize(9);
        doc.text(addr, 8, 52, { maxWidth: 90 });

        // Barcode Simulation
        doc.setFillColor(0, 0, 0);
        let startX = 15;
        for(let i=0; i<30; i++) {
            let w = Math.random() * 2;
            doc.rect(startX, 110, w, 15, 'F');
            startX += w + 1;
        }
        doc.text(orderID, 52.5, 130, { align: 'center' });

        doc.save(`LABEL_MAGOS_${name.replace(/\s+/g, '_')}.pdf`);
    }
</script>
</body>
</html>
